#!/usr/bin/env bash

# globals
#########

type greadlink >/dev/null 2>&1 && CWD="$(dirname "$(greadlink -f "$0")")" || \
  CWD="$(dirname "$(readlink -f "$0")")"

# run functions
###############

. $CWD/.functions.sh || error "unable to load shared functions"

# limit execution from groundcontrol
fail_in_groundcontrol "bin/release"

DOWNLOAD_URL="https://get.blueacorn.net/bin/release_linux-amd64_latest"
DOWNLOAD_HASH="https://get.blueacorn.net/bin/release_linux-amd64_latest.md5"
if [[ $OSTYPE == darwin* ]]; then
    DOWNLOAD_URL=${DOWNLOAD_URL//release_linux/release_darwin}
    DOWNLOAD_HASH=${DOWNLOAD_HASH//release_linux/release_darwin}
fi

RELEASE_BIN=$REPO_ROOT/$SKEL_DIR/bin/downloads/release

mkdir -p $(dirname $RELEASE_BIN) 2>/dev/null

function download() {
  curl -Lf $DOWNLOAD_URL > $RELEASE_BIN
  chmod +x $RELEASE_BIN
}

if [ -e $RELEASE_BIN ]; then
  REMOTE_HASH=$(curl -sL $DOWNLOAD_HASH)
  LOCAL_HASH=$(md5sum $RELEASE_BIN | awk '{print $1}')

  if [ "$REMOTE_HASH" != "$LOCAL_HASH" ]; then
    download
  fi
else
  download
fi

exec $RELEASE_BIN $@
exit $?
