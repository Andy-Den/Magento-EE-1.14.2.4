---

#
# default dockerized environment composition.
#
# variable defaults:
#  SUBDOMAIN: @CLIENT_CODE
#             VTB
#
#  DOMAIN: @ENV.blueacorn.net
#          qa-1.blueacorn.net
#
# !!! DO NOT EDIT THIS FILE !!!
#
# To make changes, save as docker-compose.yml
#  docker-compose.yml takes precendce over docker-compose.skel.yml
#
#  alternatively, you can override on a **per-environment basis** by saving
#  as docker-compose.yml in the environment directory,
#    e.g. /site/skel/env/production/docker-compose.yml
#
# !!! DO NOT EDIT THIS FILE !!!
#

nginx:
  container_name: ${ENV}-${CLIENT_CODE}-nginx
  restart: unless-stopped
  image: registry.badevops.com/mage-nginx:m1
  links:
    - phpfpm
    - term
    - smtp
  volumes:
    - /docker-volumes/dockerized-envs/${CLIENT_CODE}-${ENV}-magento:/magento

  environment:
    VIRTUAL_HOST: "${SUBDOMAIN}.${DOMAIN}"
    APP_ROOT: "${APP_ROOT}"

    # disable HTTP basic auth by providing EMPTY ("") values.
    AUTH_BASIC_USER: "blueacorn"
    AUTH_BASIC_PASS: "pass4blueacorn"

# nginx_deux:
#   container_name: ${ENV}-${CLIENT_CODE}-nginx-deux
#   image: registry.badevops.com/mage-nginx:m1
#   links:
#     - phpfpm
#     - term
#     - smtp
#   volumes:
#     - /docker-volumes/dockerized-envs/${CLIENT_CODE}-${ENV}-magento:/magento
#
#   environment:
#     VIRTUAL_HOST: "deux.${DOMAIN}"
#     APP_ROOT: "${APP_ROOT}"
#     MAGE_RUN_CODE: "deux"
#
#     # disable HTTP basic auth by providing EMPTY ("") values.
#     AUTH_BASIC_USER: "blueacorn"
#     AUTH_BASIC_PASS: "pass4blueacorn"

phpfpm:
  container_name: ${ENV}-${CLIENT_CODE}-phpfpm
  restart: unless-stopped
  image: registry.badevops.com/mage-phpfpm:m1
  links:
    - mysql
    - smtp
  volumes:
    - /docker-volumes/dockerized-envs/${CLIENT_CODE}-${ENV}-magento:/magento

term:
  container_name: ${ENV}-${CLIENT_CODE}-term
  restart: unless-stopped
  build: ./
  dockerfile: Dockerfile-term.skel
  links:
    - smtp
    - mysql
  volumes:
    - /docker-volumes/dockerized-envs/${CLIENT_CODE}-${ENV}-magento:/magento
    - /docker-volumes/dockerized-envs/${CLIENT_CODE}-${ENV}-cron:/etc/periodic
    - /nfs:/nfs:${NFS_MODE}

  environment:
    APP_URL: ${APP_URL}
    APP_ROOT: ${APP_ROOT}
    CLIENT_CODE: ${CLIENT_CODE}
    REPO_REMOTE: ${REPO_REMOTE}
    REPO_REF: ${REPO_REF}
    SNAPSHOT_BASE_ENV: ${SNAPSHOT_BASE_ENV}
    MYSQL_USER: magento
    MYSQL_PASSWORD: magento
    MYSQL_DATABASE: magento
    OAUTH_DOMAIN: auth.blueacorn.net
    OAUTH_APP: ${CLIENT_CODE}-${ENV}

cron:
  container_name: ${ENV}-${CLIENT_CODE}-cron
  restart: unless-stopped
  log_driver: none
  image: registry.badevops.com/mage-cron:m1
  links:
    - mysql
    - smtp
  volumes:
    - /docker-volumes/dockerized-envs/${CLIENT_CODE}-${ENV}-magento:/magento
    - /docker-volumes/dockerized-envs/${CLIENT_CODE}-${ENV}-cron:/etc/periodic

  environment:
    CRON_LOG_DIR: ${APP_ROOT}/var/log

smtp:
  container_name: ${ENV}-${CLIENT_CODE}-smtp
  image: registry.badevops.com/mage-smtp
  log_driver: none

mysql:
  container_name: ${ENV}-${CLIENT_CODE}-mysql
  restart: unless-stopped
  image: mariadb:10
  volumes:
    - /docker-volumes/dockerized-envs/${CLIENT_CODE}-${ENV}-mysql:/var/lib/mysql

  environment:
    MYSQL_USER: magento
    MYSQL_PASSWORD: magento
    MYSQL_DATABASE: magento
    MYSQL_ROOT_PASSWORD: lowfi